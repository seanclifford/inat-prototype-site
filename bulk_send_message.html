<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
  
    <title>INat prototypes - Bulk Send Messages PROTOTYPE</title>
    <meta name="description" content="Bulk Send Messages prototype for INaturalist">
    <meta name="author" content="Sean Clifford">
  
    <link rel="stylesheet" href="css/styles.css?v=1.0">
  
    
  </head>
  
  <body>
    <h1>Bulk Send Messages prototype for INaturalist</h1>
    <h2>TODO:</h2>
    <ul>
      <li>Authenticate properly</li>
      <li>Replace tokens with dynamic values in messages. i.e. Hi @username! </li>
      <li>Add userhandle to user list</li>
      <li>Load observation ids from a file (observations get response json)</li>
    </ul>

    <h2>Start here:</h2>
    <ul>
      <li>Enter csv of user ids<br/>
        <input type="text" id="user_ids">
      </li>
      <li>OR Enter csv of observation ids<br/>
        <input type="text" id="observation_ids">
      </li>
      <li>
        <input type="button" value='Load Users' onclick='loadUsers()'>
        <div id='users_found'></div>
      </li>
      <li>Enter subject <br/>
        <input type="text" id="subject">
      </li>
      <li>Enter message <br/>
        <textarea id='message'></textarea>
      </li>
      <li>Enter user session token. Go to <a href='https://inaturalist.nz/users/api_token' target="_blank">this page</a>, copy the api_token value without quotes, and paste it below:<br/>
        <input type="text" id="auth_token">
      </li>
      <li>
        <input type="button" value='Send Messages' onclick='sendMessages()'><br/>
        <div id="send_result"></div>
      </li>
    </ul>
  
    <script src="js/api.js"></script>
    <script>
      var userIds = [];
      async function loadUsers() {
        let userNamesCsv = document.getElementById("user_ids").value;
        let observationIdsCsv = document.getElementById("observation_ids").value;
        if (userNamesCsv) {
          await getUsersByNamesCsv(userNamesCsv);
        }
        else if (observationIdsCsv) {
          await getUsersByObservations(observationIdsCsv);
        }
        else {
          alert('Enter some user names or observation ids')
        }
      }
      async function getUsersByObservations(observationIdsCsv) {
        let convertedCsv = observationIdsCsv.replace(/\s/g,'');
        let observations = await Api.getObservations(convertedCsv);
        let div = document.getElementById('users_found');
        div.innerHTML = "";
        if (observations.status === 'ERROR'){
          div.innerHTML += `<p>${observations.message}</p>`
        }
        else {
          const obsUsers = observations.map(observation => observation.user);
          const uniqueObsUsers = [];
          const map = new Map();
          for (const user of obsUsers) {
            if(!map.has(user.id)){
              map.set(user.id, true);
              uniqueObsUsers.push(user);
            }
          }
          uniqueObsUsers.forEach(user => {
            addUser(div, user);
          });
        }
      }
      async function getUsersByNamesCsv(userNamesCsv) {
        const userNames = userNamesCsv.split(',');
        await getUsersByNamesArray(userNames)
      }
      async function getUsersByNamesArray(userNames) {
        userIds = [];
        let div = document.getElementById('users_found');
        div.innerHTML = "";
        for(let i = 0; i < userNames.length; i++) {
          let user = await Api.getUser(userNames[i])
          if (user.status === 'ERROR') {
            div.innerHTML += `<p>${user.message}</p>`;
          }
          else {
            addUser(div, user);
          }
        }
      }
      function addUser(div, user) {
        userIds.push(user.id);
        var userHandle = user.login;
        if(user.name) {
          userHandle += ` (${user.name})`;
        }
        if (user.icon) {
          div.innerHTML += `<img width='30' src='${user.icon}'> `
        }
        div.innerHTML += `${userHandle}<br/>`;
      }
      async function sendMessages(){ 
        let subject = document.getElementById('subject').value;
        let message = document.getElementById('message').value;
        let authToken = document.getElementById('auth_token').value;
        
        let results = await Promise.all(userIds.map(async (userId) => {
          return await Api.sendMessage(userId, subject, message, authToken);
        }));

        let errorResults = results.filter(result => result.status === 'ERROR');
        let successCount = results.length - errorResults.length;
        let sendMessageResult = `Successfully sent ${successCount} out of ${results.length} message.`;
        if (errorResults.length > 0) {
          sendMessageResult += ' ERRORS:';
          errorResults.forEach(error => sendMessageResult += error.message + ' ');
        }
        let div = document.getElementById('send_result');
        div.innerHTML = `<p>${sendMessageResult}</p>`;
      }
    </script>
  </body>
</html>