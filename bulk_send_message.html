<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
  
    <title>iNat prototypes - Bulk Send Messages PROTOTYPE</title>
    <meta name="description" content="Bulk Send Messages prototype for iNaturalist">
    <meta name="author" content="Sean Clifford">
    <link rel="shortcut icon" href="favicon.ico" type="image/icon">
    <link rel="stylesheet" href="css/styles.css?v=1.0">
    <style>
        input[type=text] { width: 400px}
        #message { min-height: 200px; width: 400px}
    </style>
  </head>
  
  <body>
    
    <site-header id="site_header"></site-header>
    
    <h1>Bulk Send Messages prototype for iNaturalist</h1> 
    
    <h2>Start here:</h2>
    <ol>
      <li>
        <input type="button" value='Check authentication' onclick='authenticate()'>
        <div id="authenticated_user" class="user"></div>
      </li>
      <li>
          <legend>Choose data source to load users from:</legend>
          <label><input type="radio" name="user_load" value="user_ids" onchange="userLoadChanged()" checked>User IDs</label><br>
          <label><input type="radio" name="user_load" value="fileUpload" onchange="userLoadChanged()">Export file (JSON)</label><br>
          <label><input type="radio" name="user_load" value="observation_ids" onchange="userLoadChanged()">Observation IDs</label><br>
          <label><input type="radio" name="user_load" value="project_id" onchange="userLoadChanged()">Project ID</label><br>
      </li>
      <li>
        <div id="user_ids_container">
          Enter comma separated list of user ids. e.g. johnsmith736,khaleesi89<br/>
          <input type="search" id="user_ids">
        </div>
        <div id="fileUpload_container">
          Load from observations export file (JSON format) to message the observers of the observations.<br/>
          <input type="file" id="fileUpload" />
        </div>
        <div id="observation_ids_container">
          Enter comma separated list of observation ids to message the observers of the observations.<br/>
          <input type="search" id="observation_ids">
        </div>
        <div id="project_id_container">
          Enter project id to load its members. This is in the url on the project page. e.g. stinkbugs-of-the-world<br/>
          <input type="search" id="project_id">
        </div>
      </li>
      <li>
        <input type="button" value='Load Users' onclick='loadUsers()'>
        <div id='users_found' class="user"></div>
      </li>
      <li>Enter subject <br/>
        <input type="text" id="subject">
      </li>
      <li>Enter message <br/>
        <textarea id='message'></textarea>
      </li>
      <li>
        <input id="send" type="button" value='Send Messages' onclick='sendMessages()'><br/>
        <div id="send_result"></div>
      </li>
    </ol>

    <br>
    <br>
    <h2>Still to work on for this prototype:</h2>
    <ul>
      <li>Allow remove individual users</li>
      <li>Import users from csv export</li>
      <li>Replace tokens with dynamic values in messages. i.e. Hi @username! </li>
      <li>Tech: html encode all external values</li>
      <li>Test this works in practice</li>
    </ul>
  
    <script src="js/constants.js?v=1.0.0"></script>
    <script src="js/api.js?v=1.0.0"></script>
    <script src="js/bulk_send_message.js?v=1.0.0"></script>
    <script src="js/auth.js?v=1.0.0"></script>
    <script src="js/site.js?v=1.0.0"></script>
    <script src="js/components/site_header.js?v=1.0.0"></script>
    <script src="js/components/user_info.js?v=1.0.0"></script>
    <script>
        (async () => {
          userLoadChanged();
          const currentSite = await getCurrentSite();
          
          const siteHeader = document.getElementById("site_header");
          siteHeader.setSite(currentSite);
        })();

      async function authenticate() {
        await Api.ensureAuthenticated();
        const div = document.getElementById('authenticated_user');
            
        const user = await getAuthenticatedUser();

        if (user) {
          div.innerHTML = "Logged in as: ";
          div.innerHTML += `<user-info img='${user.icon ?? ''}' login='${user.login}' name='${user.name}'>`;
        }
      }

      function userLoadChanged() {
        const radioButtons = document.getElementsByName("user_load");
        for (i = 0; i < radioButtons.length; i++) {
          let radioButton = radioButtons[i];
          let inputContainerDisplay = 'none';
          if (radioButton.checked) {
            inputContainerDisplay = 'block';
          }
          const inputContainer = document.getElementById(`${radioButton.value}_container`);
          inputContainer.style.display = inputContainerDisplay;
        }
      }

      async function loadUsers() {
        const userLoadType = document.querySelector('input[name="user_load"]:checked').value;
        switch(userLoadType)
        {
          case 'fileUpload':
            let fileUpload = document.getElementById("fileUpload").files[0];
            getUsersFromFile(fileUpload);
            break;

          case 'user_ids':
            let userNamesCsv = document.getElementById("user_ids").value;
            await getUsersByNamesCsv(userNamesCsv);
            break;

          case 'observation_ids':
            let observationIdsCsv = document.getElementById("observation_ids").value;
            await getUsersByObservationsCsv(observationIdsCsv);
            break;

          case 'project_id':
            let projectId = document.getElementById("project_id").value;
            await getUsersByProjectMembers(projectId);
            break;

          default:
            alert('Enter some user names or observation ids, observations file or project id')
        }

        if(users) {
          let sendButton = document.getElementById("send");
          sendButton.value = `Send ${users.length} Message`
          if (users.length != 1){
            sendButton.value += 's'
          }
        }
      }      

      async function sendMessages(){ 
        let subject = document.getElementById('subject').value;
        let message = document.getElementById('message').value;
        let apiToken = await getApiToken();
        let div = document.getElementById('send_result');
        div.innerHTML = '<p>Sending...</p>';

        const result = await sendMessagesToUsers(subject, message, apiToken, onMessageSend);
        
        div.innerHTML = `<p>${result}</p>`;
      }

      function onMessageSend(user, currentNum, totalCount) {
        let div = document.getElementById('send_result');
        div.innerHTML = `<p>Sent message ${currentNum} of ${totalCount} to user ${user.login}...</p><progress value="${currentNum}" max="${totalCount}"/>`;
      }

      function setError(error) {
        let div = document.getElementById('users_found');
        div.innerHTML += `<p>${error.message}</p>`;
      }
      
      function resetUserResults() {
        let div = document.getElementById('users_found');
        div.innerHTML = "";
      }

      function addUserResult(userResult) {
        let div = document.getElementById('users_found');
        div.innerHTML += `<user-info img='${userResult.icon}' login='${userResult.login}' name='${userResult.name}'>`;
      }
      
    </script>
  </body>
</html>