<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8">
  
    <title>iNat prototypes - Auto Combine Observations PROTOTYPE</title>
    <meta name="description" content="Auto Combine Observations prototype for iNaturalist">
    <meta name="author" content="Sean Clifford">
    <link rel="shortcut icon" href="favicon.ico" type="image/icon">
    <link rel="stylesheet" href="css/styles.css?v=1.0">
    <style>
        input[type=text] { width: 400px}
        #message { min-height: 200px; width: 400px}
    </style>
  </head>
  
  <body>
    
    <site-header id="site_header"></site-header>
    
    <h1>Auto Combine Observations prototype for iNaturalist</h1> 
    
    This tool creates a suggestion link for an owner of some observations to automatically combine them into a single observation.<br>
    This can be useful when finding new users that have not got the hang of the web uploader yet and end up creating multiple observations accidentally.

    <h2>Start here:</h2>
    <ol>
      <li>
        Enter the observation IDs to merge in a comma separated list. The first one will be the one that's kept.<br>
        <input type="text" id="observation_ids">
      </li>
      <li>
        <input type="button" value='Check observations' onclick='checkObservations()'>
        <div id='observations_found'></div>
      </li>
      <li><input type="button" value='Generate link' onclick='generateLink()'><br/>
        <input type="text" id="link">
      </li>
      <li>
        Copy the link and add it to a comment
      </li>
    </ol>

    <br>
    <br>
    <h5>Still to work on for this prototype: <a href="https://github.com/seanclifford/inat-prototype-site/projects/2">Github project todo list</a></h5>

    <script src="js/components/site_header.js?v=1.0.0"></script>
    <script src="js/components/user_info.js?v=1.0.0"></script>
    <script type="module">
      import { THIS_SITE_URI } from "./js/constants.js"
      import { getCurrentSite, getSiteUrl } from "./js/site.js"
      import { Api } from "./js/api.js"

      globalThis.checkObservations = checkObservations;
      globalThis.generateLink = generateLink;

      (async () => {
        const currentSite = await getCurrentSite();

        const siteHeader = document.getElementById("site_header");
        siteHeader.setSite(currentSite);
      })();

      function getObservationIdCsv() {
        const observationIdsCsv = document.getElementById("observation_ids").value;
        const convertedCsv = observationIdsCsv.replace(/\s/g,'');
        return convertedCsv;
      }

      async function checkObservations() {
        const observations = await Api.getObservations(getObservationIdCsv());
        let observationsDiv = document.getElementById("observations_found");
        observationsDiv.innerHTML = "";
        const distinctUserLogins = [...new Set(observations.map(o => o.user.login))];
        if (distinctUserLogins.length > 1) {
          observationsDiv.textContent = `These observations are not owned by the same user. You have entered observations for: ${distinctUserLogins.toString()}`;
        }
        else {
          observationsDiv.textContent = '';
          
          let author = observations[0].user;
          let authorUserInfo = document.createElement('user-info');
          authorUserInfo.setAttribute('img', author.icon_url);
          authorUserInfo.setAttribute('login', author.login);
          authorUserInfo.setAttribute('name', author.name);
          observationsDiv.appendChild(authorUserInfo);

          observations.forEach(async (observation) => {
            let observationDiv = document.createElement('div');
            observationDiv.setAttribute('class', 'observation');
            
            let observationHeaderDiv = document.createElement('div');
            observationHeaderDiv.setAttribute('class', 'observation_header');
            let observationLink = document.createElement('a');
            observationLink.href = await getSiteUrl(`/observations/${observation.id}`);
            observationLink.textContent = `${observation.id} - ${observation.species_guess}`;
            observationHeaderDiv.append(observationLink);
            observationDiv.append(observationHeaderDiv);

            let observationDateTimeDiv = document.createElement('div');
            observationDateTimeDiv.textContent = observation.observed_on_string;
            observationDiv.append(observationDateTimeDiv);
            
            if (observation.photos.length > 0) {
              const observationFirstPhoto = document.createElement('img');
              const smallPhotoUrl = setImageSizeUrl(observation.photos[0].url, 'small');
              observationFirstPhoto.setAttribute('src', smallPhotoUrl);

              observationDiv.appendChild(observationFirstPhoto);
            }

            const statsList = document.createElement('div');
            statsList.setAttribute('class', 'observation_info');

            const photoCountItem = document.createElement('div');
            photoCountItem.textContent = `Photos: ${observation.photos.length}`;
            statsList.appendChild(photoCountItem);

            const idCountItem = document.createElement('div');
            idCountItem.textContent = `IDs: ${observation.identifications.length}`;
            statsList.appendChild(idCountItem);

            const commentsCountItem = document.createElement('div');
            commentsCountItem.textContent = `Comments: ${observation.comments.length}`;
            statsList.appendChild(commentsCountItem);

            const qualityGrade = observation.quality_grade;
            let qualityGradeText = "";
            if (qualityGrade == 'research') {
              qualityGradeText = "Research Grade";
            } else if (qualityGrade == 'casual') {
              qualityGradeText = "Casual";
            }
            if (qualityGradeText) {
              const qualityGradeItem = document.createElement('div');
              qualityGradeItem.setAttribute('class', `quality_grade ${qualityGrade}`);
              qualityGradeItem.textContent = qualityGradeText;
              statsList.appendChild(qualityGradeItem);
            }


            observationDiv.appendChild(statsList);

            observationsDiv.appendChild(observationDiv);
          });
        }
      }

      function setImageSizeUrl(url, size) {
        return url.replace('square.jpeg', `${size}.jpeg`)
      }

      function generateLink() {
        const autoCombineUrl = new URL(`${THIS_SITE_URI}/auto_combine.html`);
        autoCombineUrl.searchParams.append('observation_ids', getObservationIdCsv())

        const linkTextBox = document.getElementById('link');
        linkTextBox.value = autoCombineUrl.toString();
      }
    </script>
  </body>
</html>